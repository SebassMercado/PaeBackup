<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>Gesti√≥n de Producciones</title> 
    <style>
        /* MODO OSCURO PARA PRIMEFACES DIALOG */
body.dark .ui-dialog {
    background-color: #1f1f1f !important;
    color: #e0e0e0 !important;
    border-radius: 8px !important;
    border: 1px solid #444 !important;
}

body.dark .ui-dialog .ui-dialog-titlebar {
    background-color: #2a2a2a !important;
    color: #ffffff !important;
    border-bottom: 1px solid #444 !important;
    font-weight: bold;
}

body.dark .ui-dialog .ui-dialog-title {
    color: #ffffff !important;
}

body.dark .ui-dialog .ui-dialog-titlebar-close {
    color: #ffffff !important;
    filter: invert(1); /* Hace visible el √≠cono */
}

body.dark .ui-dialog .ui-dialog-content {
    background-color: #1f1f1f !important;
    color: #e0e0e0 !important;
}

/* Inputs dentro del dialog */
body.dark .ui-dialog .ui-inputfield,
body.dark .ui-dialog input,
body.dark .ui-dialog select,
body.dark .ui-dialog textarea {
    background-color: #2a2a2a !important;
    color: #e0e0e0 !important;
    border: 1px solid #555 !important;
}

/* Footer del dialog */
body.dark .ui-dialog .ui-dialog-footer {
    background-color: #1f1f1f !important;
    border-top: 1px solid #444 !important;
}

/* Botones del dialog */
body.dark .ui-dialog .btn,
body.dark .ui-dialog .ui-button {
    background-color: transparent !important;
    color: #ffffff !important;
    border: 1px solid #0d6efd !important;
}

body.dark .ui-dialog .btn:hover,
body.dark .ui-dialog .ui-button:hover {
    background-color: rgba(255,255,255,0.1) !important;
}

    </style>  
    
</h:head>

<h:body>
    <ui:include src="/views/Navbar.xhtml" />
    <f:event type="preRenderView" listener="#{produccionBean.listar}" />
    <p:growl id="msj" showDetail="true" showSummary="true" />

    <section class="home">
        <div class="contenedor">
            <div class="tabla">
                <section class="card">
                    <h:form id="formProduccion">

                        <!-- ENCABEZADO -->
                        <div class="encabezado">
                            <h2><i class='bx bx-cog'></i> Gesti√≥n de Producciones</h2>
                            <div>
                                <h:commandButton value="Nueva Producci√≥n"
                                                 action="nuevaproduccion?faces-redirect=true"
                                                 styleClass="export-btn" />
                                <h:commandButton value="Exportar Excel"
                                                 style="margin-left: 10px"
                                                 styleClass="export-btn"
                                                 actionListener="#{produccionBean.exportarExcel}" />
                                <h:commandButton value="Generar PDF"
                                                 style="margin-left: 10px"
                                                 styleClass="export-btn"
                                                 actionListener="#{produccionBean.generarReportePDF}" />
                            </div>
                        </div>

                        <!-- TABLA -->
                        <h:panelGroup id="tablaProduccionWrapper">
                            <div class="wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID <span class="draggable" onmousedown="initResize(0)"></span></th>
                                            <th>Fecha Registro <span class="draggable" onmousedown="initResize(1)"></span></th>
                                            <th>Asignado por <span class="draggable" onmousedown="initResize(2)"></span></th>
                                            <th>Asignado a <span class="draggable" onmousedown="initResize(3)"></span></th>
                                            <th>Estado <span class="draggable" onmousedown="initResize(4)"></span></th>
                                            <th style="width:13rem">Opciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <ui:repeat value="#{produccionBean.lstProduccion}" var="prod">
                                            <tr>
                                                <td><span class="cell-content"><h:outputText value="#{prod.id_proc}" /></span></td>

                                                <td>
                                                    <span class="cell-content">
                                                        <h:outputText value="#{prod.fecha_hora}">
                                                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
                                                        </h:outputText>
                                                    </span>
                                                </td>

                                                <td>
                                                    <span class="cell-content">
                                                        <h:outputText 
                                                            value="#{empty prod.nombreUsuario ? 'Sin asignar' : prod.nombreUsuario.concat(' ').concat(prod.apellidoUsuario)}" />
                                                    </span>
                                                </td>

                                                <td>
                                                    <span class="cell-content">
                                                        <h:outputText 
                                                            value="#{empty prod.nombreAsignado ? 'Sin asignar' : prod.nombreAsignado.concat(' ').concat(prod.apellidoAsignado)}" />
                                                    </span>
                                                </td>

                                                <td>
                                                    <span class="cell-content">
                                                        <h:outputText 
    value="#{prod.estado}" 
    style="font-weight:bold; color:
           #{prod.estado eq 'Pendiente' ? 'orange' :
             prod.estado eq 'Aceptada' ? 'blue' :
             prod.estado eq 'Finalizada' ? 'green' :
             prod.estado eq 'Esperando insumos' ? 'red' : 'black'};" />
                                                    </span>
                                                </td>

                                                <td>
                                                    <!-- OPCIONES -->
                                                    <div style="display:flex; gap:6px; justify-content:center;">
                                                        
                                                        <!-- Aceptar -->
<h:panelGroup rendered="#{prod.estado eq 'Pendiente'}">
    <h:commandLink title="Aceptar producci√≥n"
                   styleClass="btn btn-outline-primary">
        <i class="bi bi-check"></i>
        <f:ajax execute="@this"
        render=":formProduccion:tablaProduccionWrapper :formProduccion:msj"
        listener="#{produccionBean.cambiarEstadoCiclo(prod)}"/>
    </h:commandLink>
</h:panelGroup>

<!-- Finalizar -->
<h:panelGroup rendered="#{prod.estado eq 'Aceptada'}">
    <h:commandLink title="Finalizar producci√≥n"
                   styleClass="btn btn-outline-success">
        <i class="bi bi-flag"></i>
        <f:ajax execute="@this"
        render=":formProduccion:tablaProduccionWrapper :formProduccion:msj"
        listener="#{produccionBean.cambiarEstadoCiclo(prod)}"/>

    </h:commandLink>
</h:panelGroup>

<!-- Reintentar cuando est√° en Esperando insumos -->
<h:panelGroup rendered="#{prod.estado eq 'Esperando insumos'}">
    <h:commandLink title="Reintentar finalizar producci√≥n (pendiente de stock)"
                   styleClass="btn btn-outline-warning">
        <i class="bi bi-arrow-repeat"></i>
        <f:ajax execute="@this"
                render=":formProduccion:tablaProduccionWrapper :formProduccion:msj"
                listener="#{produccionBean.cambiarEstadoCiclo(prod)}"/>
    </h:commandLink>
</h:panelGroup>


                                                        <!-- Fechas -->
                                                        <p:commandLink title="Ver trazabilidad de fechas"
               styleClass="btn btn-outline-warning"
               update=":dialogFechas"
               oncomplete="PF('dlgFechas').show();">
    <i class="bi bi-clock"></i>
    <f:setPropertyActionListener target="#{produccionBean.produccionSeleccionada}" value="#{prod}" />
</p:commandLink>

                                                        <!-- Ver recetas -->
                                                        <p:commandLink title="Ver Recetas"
               action="#{produccionBean.irARecetasProduccion}"
               styleClass="btn btn-outline-info">
    <i class="bi bi-basket"></i>
    <f:setPropertyActionListener target="#{produccionBean.produccionSeleccionada}" value="#{prod}" />
</p:commandLink>


                                                      <!-- Eliminar -->
<h:commandLink title="Eliminar"
               styleClass="btn btn-outline-danger"
               onclick="return confirm('¬øEst√° seguro de eliminar esta producci√≥n?');">
    <i class="bi bi-trash"></i>
    <f:ajax execute="@this" 
            render="@form msj"
            listener="#{produccionBean.eliminar(prod)}" />
</h:commandLink>

                                                    </div>
                                                </td>
                                            </tr>
                                        </ui:repeat>
                                    </tbody>
                                </table>
                            </div>
                        </h:panelGroup>

                        <!-- BOT√ìN VOLVER -->
                        <h:commandLink styleClass="btn-back" 
                                       action="/views/Dashboard.xhtml?faces-redirect=true">
                            <i class='bx bx-chevron-left'></i> Volver
                        </h:commandLink>

                    </h:form>
                </section>
            </div>
        </div>
    </section>

    <!-- DIALOGO DE FECHAS -->
    <p:dialog id="dialogFechas" widgetVar="dlgFechas" modal="true" 
              header="Trazabilidad de Producci√≥n"
              showEffect="fade" hideEffect="fade" closable="true" 
              resizable="false" width="600">
        <h:panelGrid columns="2" cellpadding="10" columnClasses="col1,col2" style="width:100%">
            <h:outputText value="üìÖ Fecha de creaci√≥n:" style="font-weight:bold;"/>
            <h:outputText value="#{produccionBean.produccionSeleccionada.fecha_hora}">
                <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
            </h:outputText>

            <h:outputText value="‚úÖ Fecha de aceptaci√≥n:" style="font-weight:bold;"/>
            <h:outputText value="#{produccionBean.produccionSeleccionada.fecha_aceptacion != null ? 
                                   produccionBean.produccionSeleccionada.fecha_aceptacion : 'Pendiente'}">
                <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
            </h:outputText>

            <h:outputText value="üèÅ Fecha de finalizaci√≥n:" style="font-weight:bold;"/>
            <h:outputText value="#{produccionBean.produccionSeleccionada.fecha_finalizacion != null ? 
                                   produccionBean.produccionSeleccionada.fecha_finalizacion : 'Pendiente'}">
                <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
            </h:outputText>
        </h:panelGrid>

        <f:facet name="footer">
            <p:commandButton value="Cerrar" icon="pi pi-times" 
                             onclick="PF('dlgFechas').hide()" 
                             styleClass="btn btn-secondary" />
        </f:facet>
    </p:dialog>

    <script type="text/javascript" src="/assets/js/tabla.js"></script>
</h:body>
</html>
