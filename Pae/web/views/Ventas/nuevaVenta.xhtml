<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Registrar Nueva Venta</title>
    <h:outputStylesheet library="css" name="formularios_1.css"/>
    <link href="https://cdn.jsdelivr.net/npm/primeicons@6.0.1/primeicons.css" rel="stylesheet"/>
    <style>
        /* ===== Home y Card dinámico ===== */
        .home {
            position: relative;
            height: 100vh;
            left: 250px;
            width: calc(100% - 250px);
            transition: left 0.3s ease, width 0.3s ease;
        }

        .sidebar.close ~ .home {
            left: 88px;
            width: calc(100% - 88px);
        }

        .card-form {
            width: calc(100% - 40px);
            max-width: 1100px;
            margin: 20px auto;
            padding: 30px 35px;
            border-radius: 14px;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: width 0.3s ease, margin 0.3s ease;
        }

        /* Inputs */
        .input, .select, .input-textarea {
            width: 100%;
            padding: 10px 8px;
            border: none;
            border-bottom: 2px solid #ccc;
            outline: none;
        }
        .input:focus, .select:focus, .input-textarea:focus {
            border-bottom: 2px solid #2e86de;
            background: #f9fbff;
        }
        .select {
            border-radius: 4px;
            cursor: pointer;
            background: #fafafa;
        }

        /* Botones */
        .btn-primario {
            color: #dc3545;
            border: 2px solid #dc3545;
            background: transparent;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-primario:hover { background: #dc3545; color: #fff; }

        .btn-secundario {
            color: #6c757d;
            border: 2px solid #6c757d;
            background: transparent;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-secundario:hover { background: #6c757d; color: #fff; }

        .btn-verde {
            color: #fff;
            background-color: #28a745;
            border: 2px solid #28a745;
        }
        .btn-verde:hover { background-color: #1e7e34; }

        .btn-rojo {
            color: #fff;
            background-color: #dc3545;
            border: 2px solid #dc3545;
        }
        .btn-rojo:hover { background-color: #a71d2a; }

        /* Tablas */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th, table td {
            padding: 8px 12px;
            border: 1px solid #ccc;
            text-align: left;
        }

        /* Layout */
        h2 { text-align: center; color: #2c3e50; font-size: 22px; margin-bottom: 25px; }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-group.full { grid-column: 1 / -1; }

        /* Responsive móvil */
        @media (max-width: 600px) {
            .card-form { width: 95%; padding: 25px; }
            .form-row { grid-template-columns: 1fr; }
        }
        
        .form-row {
    display: flex;
    gap: 20px;
    align-items: flex-end; 
    flex-wrap: wrap;
}

/* ancho fijo para que el precio quede alineado */
.form-group:first-child {
    width: 250px;  /* ajusta si quieres más o menos */
}

.form-group {
    display: flex;
    flex-direction: column;
}

/* Contenedor NO alinea verticalmente el label */
.check-inline {
    display: flex;
    align-items: flex-start;  /* label arriba */
    gap: 10px;
    margin-bottom: 15px;
}

/* El checkbox se baja al centro exacto del texto */
.check-inline h\:selectBooleanCheckbox,
.check-inline input[type="checkbox"] {
    margin-top: 5px !important; /* Ajuste fino */
}

/* Textarea normal (modo claro) */
.input-textarea {
    background: #fff;
    color: #000;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 6px;
}

/* Textarea en modo oscuro */
body.dark .input-textarea,
.dark-mode .input-textarea {
    background: #1f1f1f !important;
    color: #f1f1f1 !important;
    border: 1px solid #444 !important;
}



    </style>
</h:head>

<h:body>
    <ui:include src="/views/Navbar.xhtml" />
    <f:event type="preRenderView" listener="#{ventasBean.inicializarNuevaVenta}" />

    <section class="home">
        <div class="card-form">
            <h:form id="formVentaCompleto">
                <h2>Registrar Nueva Venta</h2>
 
                
                <!-- Usuario que registra -->
                <div class="form-group full">
                    <label for="usuarioVenta">Usuario que registra la venta</label>
                    <div style="margin-top:4px; margin-bottom:8px;">
                        <h:outputText id="usuarioVenta"
                                      value="#{sessionUser.nombres} #{sessionUser.apellidos} (#{sessionUser.rol})"
                                      styleClass="input" />
                    </div>
                    <h:inputHidden value="#{ventasBean.ventaNueva.idUsuario}" />
                </div>
                
                <div style="visibility: hidden;">Este contenido está oculto</div>
                <!-- Cliente existente -->
                <div class="form-row">
                    
                    
                    
                    <div class="form-group">
                        <label for="cliente">Cliente existente</label>
                        <h:selectOneMenu id="cliente"
                                         value="#{ventasBean.ventaNueva.idCliente}"
                                         styleClass="select"
                                         required="#{!ventasBean.nuevoCliente}"
                                         requiredMessage="Seleccione un cliente existente.">
                            <f:selectItem itemLabel="-- Seleccione --" itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{ventasBean.listaClientes}" var="cliente"
                                           itemValue="#{cliente.id_Cliente}" itemLabel="#{cliente.nombre}" />
                        </h:selectOneMenu>
                        <h:message for="cliente" style="color:#d9534f; font-size:12px; margin-top:4px; display:block;"/>
                    </div>
                    
                    

                    <div class="form-group">
                        <label for="idAsignado">Asignado a (EP)</label>
                        <h:selectOneMenu id="idAsignado"
                                         value="#{ventasBean.ventaNueva.idAsignado}"
                                         styleClass="select"
                                         required="true"
                                         requiredMessage="Seleccione el empleado.">
                            <f:selectItem itemLabel="-- Seleccione --" itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{ventasBean.listaUsuariosEP}" var="usuario"
                                           itemValue="#{usuario.idUsu}" 
                                           itemLabel="#{usuario.nombres} #{usuario.apellidos} #{ventasBean.conteo(usuario.idUsu)}" />
                        </h:selectOneMenu>
                        <h:message for="idAsignado" style="color:#d9534f; font-size:12px; margin-top:4px; display:block;"/>
                    </div>
                </div>

                <div style="visibility: hidden;">Este contenido está oculto</div>

                <div class="form-group full check-inline">
    <label for="chkNuevoCliente">¿Registrar cliente nuevo?</label>
    <h:selectBooleanCheckbox id="chkNuevoCliente" value="#{ventasBean.nuevoCliente}">
        <f:ajax render="panelNuevoCliente cliente" />
    </h:selectBooleanCheckbox>
</div>


                <h:panelGroup id="panelNuevoCliente">
                    <h:panelGroup rendered="#{ventasBean.nuevoCliente}">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre</label>
                                <h:inputText value="#{ventasBean.clienteNuevo.nombre}" styleClass="input" required="true"/>
                            </div>
                            <div class="form-group">
                                <label>Teléfono</label>
                                <h:inputText value="#{ventasBean.clienteNuevo.telefono}" styleClass="input"/>
                            </div>
                            <div class="form-group">
                                <label>Correo</label>
                                <h:inputText value="#{ventasBean.clienteNuevo.correo}" styleClass="input"/>
                            </div>
                            <div class="form-group">
                                <label>NIT</label>
                                <h:inputText value="#{ventasBean.clienteNuevo.nit}" styleClass="input" required="true"
                                             requiredMessage="El NIT es obligatorio para el cliente nuevo"/>
                            </div>
                        </div>
                    </h:panelGroup>
                </h:panelGroup>

                <div style="visibility: hidden;">Este contenido está oculto</div>
                
                <!-- Observaciones -->
                <div class="form-group full">
                    <label>Observaciones</label>
                    <h:inputTextarea value="#{ventasBean.ventaNueva.observaciones}" styleClass="input-textarea" rows="3"/>
                </div>

                
                <div style="visibility: hidden;">Este contenido está oculto</div>
                <div style="visibility: hidden;">Este contenido está oculto</div>
                
                <h3>Detalle de Empanadas</h3>
                <div style="visibility: hidden;">Este contenido está oculto</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="receta">Selecciona la empanada</label>
                        <h:selectOneMenu id="receta" value="#{ventasBean.recetaSeleccionada}" styleClass="select">
                            <f:selectItem itemLabel="-- Selecciona --" itemValue="#{null}" noSelectionOption="true" />
                            <f:selectItems value="#{ventasBean.listaRecetas}" var="r"
                                           itemValue="#{r.id_rec}" itemLabel="#{r.nombre}" />
                            <f:ajax listener="#{ventasBean.actualizarPrecioReceta}" render="precioEmpanada subtotalEmpanada"/>
                        </h:selectOneMenu>
                    </div>
                    <div class="form-group">
                        <label>Precio unitario</label>
                        <h:outputText id="precioEmpanada" value="#{ventasBean.precioRecetaSeleccionada}">
                            <f:convertNumber type="currency" currencySymbol="$"/>
                        </h:outputText>
                    </div>
                    <div class="form-group">
                        <label>Cantidad</label>
                        <h:inputText id="cantidad" value="#{ventasBean.cantidadEmpanada}" styleClass="input">
                            <f:ajax event="keyup" listener="#{ventasBean.calcularSubtotalEmpanada}" render="subtotalEmpanada"/>
                        </h:inputText>
                    </div>
                    <div class="form-group">
                        <label>Subtotal</label>
                        <h:outputText id="subtotalEmpanada" value="#{ventasBean.subtotalEmpanada}">
                            <f:convertNumber type="currency" currencySymbol="$"/>
                        </h:outputText>
                    </div>
                    <div class="form-group">
                        <h:commandButton value="Agregar al carrito"
                                         action="#{ventasBean.agregarDetalleEmpanada}"
                                         styleClass="btn-rojo" />
                    </div>
                </div>
                
                <div style="visibility: hidden;">Este contenido está oculto</div>

                <!-- Detalle de la venta -->
                <table>
                    <thead>
                        <tr>
                            <th>Empanada</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ui:repeat value="#{ventasBean.detallesVenta}" var="det">
                            <tr>
                                <td>#{det.nombreEmpanada}</td>
                                <td>#{det.cantidad}</td>
                                <td>#{det.precioUnitario}</td>
                                <td>#{det.subtotal}</td>
                                <td>
                                    <h:commandButton value="Eliminar" action="#{ventasBean.eliminarDetalle(det)}"
                                                     styleClass="btn-rojo btn-sm" />
                                </td>
                            </tr>
                        </ui:repeat>
                    </tbody>
                </table>

                <div style="visibility: hidden;">Este contenido está oculto</div>
                
                <div class="text-end mt-3">
                    <h4>Total de la venta: 
                        <h:outputText id="totalVenta" value="#{ventasBean.ventaNueva.total}">
                            <f:convertNumber type="currency" currencySymbol="$" />
                        </h:outputText>
                    </h4>
                </div>
                
                <div style="visibility: hidden;">Este contenido está oculto</div>

                <div class="botones">
                    <h:commandButton value="Registrar Venta"
                                     action="#{ventasBean.registrarVenta}"
                                     styleClass="btn-primario"/>
                    <h:commandButton value="Volver"
                                     action="#{ventasBean.volverALaLista}"
                                     immediate="true"
                                     styleClass="btn-secundario"/>
                </div>

            </h:form>
        </div>
    </section>
</h:body>
</html>
