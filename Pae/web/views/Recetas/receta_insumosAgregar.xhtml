<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>Agregar Insumo a Receta</title>
</h:head>

<h:body>

    <f:metadata>
        <f:viewParam name="idReceta" value="#{recetaInsumosBean.idReceta}" />
    </f:metadata>

    <h:form id="formAgregarInsumo">
        <h1>Agregar Insumo a la Receta</h1>

        <!-- Repetición de filas dinámicas -->
        <ui:repeat value="#{recetaInsumosBean.nuevosInsumos}" var="ri" varStatus="status">

            <p:panelGrid columns="3" columnClasses="label,value,button" style="margin-top:1rem;">
                <h:outputLabel value="Insumo:" for="insumoSelect#{status.index}" />
                <p:selectOneMenu id="insumoSelect#{status.index}" value="#{ri.id_ins}" required="true">
                    <f:selectItem itemLabel="-- Selecciona --" itemValue="" />
                    <f:selectItems value="#{recetaInsumosBean.listaInsumosDisponibles}" var="insumo"
                                   itemLabel="#{insumo.nombre} (#{insumo.cantidad} #{insumo.unidad_medida})"
                                   itemValue="#{insumo.id_ins}" />
                </p:selectOneMenu>

                <p:commandButton icon="pi pi-trash" 
                                 title="Eliminar fila"
                                 actionListener="#{recetaInsumosBean.nuevosInsumos.remove(ri)}"
                                 update="formAgregarInsumo" />
                
                <h:outputLabel value="Cantidad:" for="cantidad#{status.index}" />
                <p:inputText id="cantidad#{status.index}" value="#{ri.cantidad}" required="true" />
            </p:panelGrid>

        </ui:repeat>

        <!-- Botón para agregar nueva fila -->
        <p:commandButton value="➕ Agregar otro insumo"
                         action="#{recetaInsumosBean.agregarCampoInsumo}"
                         update="formAgregarInsumo"
                         process="@this"
                         styleClass="btn btn-secondary" />

        <!-- Botón para guardar todos los insumos -->
        <p:commandButton value="Guardar insumos"
                         action="#{recetaInsumosBean.guardarNuevosInsumos}"
                         update=":formInsumos:tablaInsumosReceta, formAgregarInsumo"
                         process="@form"
                         styleClass="btn btn-success" />

        <h:button value="Cancelar" outcome="recetas.xhtml" styleClass="btn btn-danger" />

    </h:form>

</h:body>
</html>
